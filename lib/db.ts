import Database from 'better-sqlite3';
import path from 'path';

// DB 파일 경로
const dbPath = path.join(process.cwd(), 'data', 'scholar.db');

// DB 인스턴스 생성
let db: Database.Database | null = null;

export function getDb(): Database.Database {
  if (!db) {
    db = new Database(dbPath);
    db.pragma('journal_mode = WAL');
    initializeDatabase();
  }
  return db;
}

// 데이터베이스 초기화 (테이블 생성)
function initializeDatabase() {
  const db = getDb();
  
  // 채용 공고 테이블
  db.exec(`
    CREATE TABLE IF NOT EXISTS jobs (
      id INTEGER PRIMARY KEY,
      target_audience TEXT NOT NULL,
      organizer TEXT NOT NULL,
      deadline TEXT NOT NULL,
      selection_date TEXT,
      benefit TEXT NOT NULL,
      category TEXT NOT NULL,
      full_text TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  // 장학금 테이블
  db.exec(`
    CREATE TABLE IF NOT EXISTS scholarships (
      id INTEGER PRIMARY KEY,
      target_audience TEXT NOT NULL,
      organizer TEXT NOT NULL,
      deadline TEXT NOT NULL,
      selection_date TEXT,
      benefit TEXT NOT NULL,
      category TEXT NOT NULL,
      full_text TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  // 초기 데이터 삽입 (데이터가 없을 경우에만)
  // const jobCount = db.prepare('SELECT COUNT(*) as count FROM jobs').get() as { count: number };
  
  // if (jobCount.count === 0) {
  //   const insertJob = db.prepare(`
  //     INSERT INTO jobs (target_audience, organizer, deadline, selection_date, benefit, category, full_text)
  //     VALUES (?, ?, ?, ?, ?, ?, ?)
  //   `);

  //   const jobs = [
  //     [
  //       "학사 학위 이상 소지자 (임용일 기준 졸업 예정자 지원 불가)",
  //       "성균관대학교 유학대학 유학동양한국철학과",
  //       "2025-12-30T16:00",
  //       "별도 통보",
  //       "세전 월 2,156,900원, 4대 보험 가입, 1년 이상 근무 시 퇴직금 지급",
  //       "교내 행정직",
  //       "■ 모집분야: 교내 행정직\n■ 지원자격: 학사 학위 이상 소지자 (임용일 기준 졸업 예정자 지원 불가)\n■ 주최/담당부서: 성균관대학교 유학대학 유학동양한국철학과\n■ 근무조건:\n - 월급: 세전 월 2,156,900원\n - 4대 보험 가입\n - 1년 이상 근무 시 퇴직금 지급\n■ 마감기한: 2025년 12월 30일 16:00까지\n■ 전형절차:\n 1) 서류 접수\n 2) 서류 합격자 개별 연락\n 3) 면접 진행 및 최종 선발\n■ 서류 제출 방법: 이메일 접수\n■ 합격자 발표: 별도 통보\n■ 주요업무: 학과 행정 지원 및 학생 관련 업무\n■ 문의: 학과 행정실 (전화 또는 이메일)\n\n※ 기타 자세한 내용은 학교 홈페이지 및 담당자에게 문의해주세요."
  //     ],
  //     [
  //       "대학(원) 재학생 및 졸업생",
  //       "성균관대학교 공과대학 교무팀",
  //       "2025-11-15T18:00",
  //       "2025-11-30",
  //       "월 2,000,000원, 4대 보험, 식대 지원",
  //       "조교",
  //       "■ 모집분야: 공과대학 조교\n■ 지원자격: 대학(원) 재학생 및 졸업생\n■ 주최/담당부서: 성균관대학교 공과대학 교무팀\n■ 근무조건:\n - 월 2,000,000원\n - 4대 보험 가입\n - 식대 지원\n■ 마감기한: 2025년 11월 15일 18:00까지\n■ 선발방식: 서류 및 면접\n■ 합격자 발표: 2025년 11월 30일 (예정)\n■ 주요업무: 학사업무, 행정 지원 등 학과 조교업무\n■ 제출방법: 이메일 접수\n■ 문의: 공과대학 교무팀 (이메일 또는 전화)"
  //     ],
  //     [
  //       "석사 학위 소지자 및 박사 과정 지원 가능자",
  //       "성균관대학교 자연과학캠퍼스 대학원",
  //       "2025-10-01T17:00",
  //       "지원 마감 후 2주 내 발표",
  //       "연구 장려금 연 1,000만원, 건강보험 지원",
  //       "연구직",
  //       "■ 모집분야: 대학원 연구직\n■ 지원자격: 석사 학위 소지자 및 박사 과정 지원 가능자\n■ 주최/담당부서: 성균관대학교 자연과학캠퍼스 대학원\n■ 근무조건:\n - 연구 장려금 연 1,000만원\n - 건강보험 지원\n■ 마감기한: 2025년 10월 1일 17:00까지\n■ 합격자 발표: 지원 마감 후 2주 내\n■ 주요업무: 연구실 연구 및 실험 지원\n■ 지원방법: 연구실 이메일 제출\n■ 문의: 자연과학캠퍼스 대학원 행정실"
  //     ],
  //     [
  //       "전문학사 이상 소지자로 책임감 강한 자",
  //       "성균관대학교 중앙행정실",
  //       "2025-09-10T12:00",
  //       "2025-09-20",
  //       "월 1,800,000원, 명절 상여금, 숙소 제공",
  //       "사무보조",
  //       "■ 모집분야: 사무보조\n■ 지원자격: 전문학사 이상 소지자로 책임감 강한 자\n■ 주최/담당부서: 성균관대학교 중앙행정실\n■ 근무조건:\n - 월 1,800,000원\n - 명절 상여금 별도\n - 숙소 제공\n■ 마감기한: 2025년 9월 10일 12:00까지\n■ 합격자 발표: 2025년 9월 20일 (예정)\n■ 주요업무: 행정 및 각종 지원업무\n■ 지원방법: 이메일 또는 방문 제출\n■ 문의: 중앙행정실"
  //     ],
  //     [
  //       "학부 3학년 이상 재학생",
  //       "성균관대학교 학생지원팀",
  //       "2025-08-31T23:59",
  //       "상시 심사",
  //       "근로 장학금 시급 11,000원, 도서 이용권",
  //       "근로장학생",
  //       "■ 모집분야: 근로장학생\n■ 지원자격: 학부 3학년 이상 재학생\n■ 주최/담당부서: 성균관대학교 학생지원팀\n■ 급여: 근로 장학금 시급 11,000원\n■ 복지: 도서 이용권 제공\n■ 마감기한: 2025년 8월 31일 23:59까지\n■ 선발방식: 상시 심사 (서류 및 면접)\n■ 주요업무: 도서관, 행정업무 지원 등\n■ 지원방법: 학교 온라인 신청\n■ 문의: 학생지원팀 (이메일/전화)"
  //     ]
  //   ];

  //   jobs.forEach(job => insertJob.run(...job));
  // }

  // const scholarshipCount = db.prepare('SELECT COUNT(*) as count FROM scholarships').get() as { count: number };
  
  // if (scholarshipCount.count === 0) {
  //   const insertScholarship = db.prepare(`
  //     INSERT INTO scholarships (organizer, deadline, selection_date, target_audience, benefit, category, full_text)
  //     VALUES (?, ?, ?, ?, ?, ?, ?)
  //   `);

  //   const scholarships = [
  //     [
  //       "(재)엔지니어링인재육성재단",
  //       "2026-01-16T18:00",
  //       "2026-02-01",
  //       "엔지니어링 및 신재생에너지 관련 학과 국내 4년제 대학교 3학기 이상 재학 중인 학생",
  //       "등록금 전액, 연간 생활비 200만원 지원, 재단 연수 참여 기회 제공",
  //       "교외장학",
  //       "■ 모집분야: 엔지니어링 및 신재생에너지 관련 학과 국내 4년제 대학교 3학기 이상 재학 중인 학생\n■ 지원자격: 엔지니어링 및 신재생에너지 관련 학과 국내 4년제 대학교 3학기 이상 재학 중인 학생\n■ 주최/담당부서: (재)엔지니어링인재육성재단\n■ 혜택:\n - 등록금 전액 지원\n - 연간 생활비 200만원 지원\n - 재단 연수 참여 기회 제공\n■ 마감기한: 2026년 1월 16일 18:00까지\n■ 합격자 발표: 2026년 2월 중, 개별 연락(이메일) 예정\n (일정 변경시 홈페이지 공고 예정)\n■ 문의: 엔지니어링인재육성재단 사무국 (홈페이지 : egifoundation.or.kr / 이메일 : egisf@egifoundation.or.kr)\n\n자세한 내용은 포스터 및 첨부파일 참조 부탁드립니다."
  //     ],
  //     [
  //       "성균우수인재장학회",
  //       "2025-12-20T23:59",
  //       "2026-01-10",
  //       "성균관대학교 학부 4학기 이상 이수자 중 성적 상위 10%",
  //       "학기당 200만원 지급, 성적 우수자 해외 연수 지원, 장학회 네트워크 참가 기회",
  //       "교내장학",
  //       "■ 모집분야: 성균관대학교 학부 4학기 이상 이수자 중 성적 상위 10%\n■ 지원자격: 성균관대학교 학부 4학기 이상 이수자 중 성적 상위 10%\n■ 주최/담당부서: 성균우수인재장학회\n■ 혜택:\n - 학기당 200만원 지급\n - 성적 우수자 해외 연수 지원\n - 장학회 네트워크 참가 기회\n■ 마감기한: 2025년 12월 20일 23:59까지\n■ 합격자 발표: 2026년 1월 10일 (예정)\n■ 문의: 성균우수인재장학회 (이메일 또는 전화)"
  //     ],
  //     [
  //       "BK21-융합인재장학재단",
  //       "2025-09-10T18:00",
  //       "2025-09-30",
  //       "이공계 대학원 재학생 또는 입학예정자",
  //       "연간 등록금 전액, 연구실 운영비 300만원 추가 지원",
  //       "교외장학",
  //       "■ 모집분야: 이공계 대학원 재학생 또는 입학예정자\n■ 지원자격: 이공계 대학원 재학생 또는 입학예정자\n■ 주최/담당부서: BK21-융합인재장학재단\n■ 혜택:\n - 연간 등록금 전액 지원\n - 연구실 운영비 300만원 추가 지원\n■ 마감기한: 2025년 9월 10일 18:00까지\n■ 합격자 발표: 2025년 9월 30일 (예정)\n■ 문의: BK21-융합인재장학재단 (이메일 또는 전화)"
  //     ],
  //     [
  //       "신진여성과학인재육성사업단",
  //       "2025-11-30T17:00",
  //       "2025-12-15",
  //       "여성 이공계 3, 4학년 재학생",
  //       "학기당 100만원, 멘토링 및 연구실 인턴십 기회",
  //       "특별장학",
  //       "■ 모집분야: 여성 이공계 3, 4학년 재학생\n■ 지원자격: 여성 이공계 3, 4학년 재학생\n■ 주최/담당부서: 신진여성과학인재육성사업단\n■ 혜택:\n - 학기당 100만원 지급\n - 멘토링 및 연구실 인턴십 기회\n■ 마감기한: 2025년 11월 30일 17:00까지\n■ 합격자 발표: 2025년 12월 15일 (예정)\n■ 문의: 신진여성과학인재육성사업단 (이메일 또는 전화)"
  //     ],
  //     [
  //       "공학미래재단",
  //       "2025-10-15T12:00",
  //       "2025-11-05",
  //       "대한민국 4년제 대학 공학계열 2학년 이상 재학생",
  //       "매월 50만원(1년간), 우수장학생 해외학회 참가 지원",
  //       "교외장학",
  //       "■ 모집분야: 대한민국 4년제 대학 공학계열 2학년 이상 재학생\n■ 지원자격: 대한민국 4년제 대학 공학계열 2학년 이상 재학생\n■ 주최/담당부서: 공학미래재단\n■ 혜택:\n - 매월 50만원(1년간) 지급\n - 우수장학생 해외학회 참가 지원\n■ 마감기한: 2025년 10월 15일 12:00까지\n■ 합격자 발표: 2025년 11월 5일 (예정)\n■ 문의: 공학미래재단 (이메일 또는 전화)"
  //     ]
  //   ];
  //   scholarships.forEach(scholarship => insertScholarship.run(...scholarship));
  // }
}

// DB 연결 종료
export function closeDb() {
  if (db) {
    db.close();
    db = null;
  }
}

